\documentclass{amsart}

\usepackage[utf8x]{inputenc}
\usepackage{graphicx}
\usepackage{caption}
%\usepackage{epstopdf}
\usepackage{enumerate}
\usepackage{amsmath,amsfonts,amsthm,amssymb}
\usepackage{mathrsfs}
\usepackage{url}
\usepackage{acronym}
\usepackage{thmtools}
\usepackage{nicefrac}
\usepackage{pseudocode}
% \usepackage[authoryear]{natbib}
\usepackage{wrapfig}

% Clever references
% \usepackage{cleveref}
% 
% \crefname{equation}{}{}
% \Crefname{equation}{}{}
% \crefname{figure}{figure}{figures}
% \Crefname{figure}{Figure}{Figures}
% \crefname{appendix}{Appendix}{Appendices}
% \Crefname{appendix}{Appendix}{Appendices}
% \crefname{section}{Section}{Sections}
% \Crefname{section}{Section}{Sections}

% Own stuff
\usepackage{../mathdefs}
\usepackage{../notecommand}
\usepackage{../mytheorems}
\usepackage{../other}

\usepackage[pdftex,unicode,colorlinks=true,linkcolor=black,citecolor=black,hypertexnames=true]{hyperref}
\hypersetup{pdfauthor={},pdftitle={Common representation of acquisition geometries in tomography}}

% Figure are placed in figures directory.
\graphicspath{{Pictures/}}

% Acronyms (depends on the acronym package)
\acrodef{em}[EM]{electron microscopy}
\acrodef{EM}[EM]{Electron Microscopy}
\acrodef{et}[ET]{electron tomography}
\acrodef{ET}[ET]{Electron Tomography}
\acrodef{stem}[STEM]{scanning transmission electron microscopy}
\acrodef{psf}[PSF]{point spread function}
\acrodef{PSF}[PSF]{Point Spread Function}
\acrodef{ctf}[CTF]{contrast transfer function}
\acrodef{CTF}[CTF]{Contrast Transfer Function}
\acrodef{nufFt}[FT]{non-uniform fast Fourier transform}
\acrodef{NufFt}[FT]{Non-uniform fast Fourier transform}
\acrodef{NUFFT}[FT]{Non-Uniform Fast Fourier Transform}
\acrodef{Ft}[FT]{Fourier transform}
\acrodef{FT}[FT]{Fourier Transform}
\acrodef{snr}[SNR]{signal-to-noise ratio}
\acrodef{SNR}[SNR]{Signal-to-Noise Ratio}


\title{Common representation of acquisition geometries in tomography}
\author{}
\date{\today}

% \usepackage{other}

\newcommand*{\Dinv}{{\ensuremath{D^{-1}}}}
\renewcommand*{\phi}{\varphi}

% \setlength{\parindent}{0pt}

\begin{document}

\maketitle




\section{General theory}
\label{sec:general}
%
%
%
During data acquisition, detector and sample move relative to each other. Thus, the position of a specific point on the detector varies 
with time or some other parameter, like a rotation angle. Furthermore, we consider detectors which are surface-, curve- or point-like and 
can be regarded as manifolds in $\RR^D$ parameterized over an open set in $\RR^d$ with typically $d < D$. Hence, we use the following 
representation:\\
Let $T \subset \RR^p$ be a set of (time, angle, \ldots) parameters and $U \subset \RR^d$ a set of detector parameters, e.g. $x$ and $y$ 
coordinates on a flat 2D detector. We call a mapping
%
\begin{equation}
 \label{eq:general:detector}
 X: T \times U \longrightarrow \RR^D
\end{equation}
%
the \emph{detector trace parametrization} and $X(T \times U) \subset \RR^D$ the \emph{detector trace}. For fixed $t \in T$, we define the 
\emph{detector parametrization}
%
\begin{equation}
 \label{eq:general:detector_fixedfirst}
 X_t = X(t, \cdot) : U \Lto \RR^D
\end{equation} 
%
and call $X_t(U) \subset \RR^D$ the detector surface (at time $t$).\\[1ex]
%
%
To model the very general situation of directional input (like rays) to the detector, we further define the \emph{directional field}
%
\begin{equation}
 \label{eq:general:dirfield}
 N: T \times U \Lto \SPHERE^{D-1}.
\end{equation}
%
For $t \in T$ and $u \in U$, the value $N(t, u) \in \SPHERE^{D-1}$ stands for the orientation of the detector at the point $X(t,u)$ caused 
by e.g. collimators. Often, $N(t, u)$ is the unit normal to the detector surface at $X(t, u)$. \\[1ex]
%
%
In the case that one detector point ``sees'' more than one incoming direction, we additionally define the 
\emph{detector pupil}
%
\begin{equation}
 \label{eq:general:detector_pupil}
 P: T \times U \Lto \mathrm{P}(\SPHERE^{D-1})
\end{equation} 
%
which maps $t, u$ to the subset $P(t, u) \subset \SPHERE^{D-1}$ of directions seen by the detector point at $X(t, u)$. This covers, for 
example, the case of PET where the detector pixels register not only perpendicular photons but also photons coming in at an angle.\\[1ex]
%
%
Finally, if the incoming ``radiation'' is not travelling along straight lines, we need to provide this information, too. However, we will 
restrict ourselves to the case where we can uniquely trace such a ray back from a detector point through the sample. We thus define a 
mapping
%
\begin{equation}
 \label{eq:general:rays}
 \gamma: T \times U \times \SPHERE^{D-1} \Lto C_{\mathrm{pw}}^1\big([0,\infty), \RR^d\big)
\end{equation} 
%
where for $t \in T$, $u \in U$ and $\theta \in \SPHERE^{D-1}$, the function $\gamma(t, u, \theta)$ represents the ray arriving at the 
detector point $X(t, u)$ from the direction $\theta$. The subscript ``pw'' stands for ``piecewise'' with the restriction that the lengths 
of such pieces must be bounded from below by a positive constant.  If $P(t,u) = \lbrace N(t,u)\rbrace$, we write 
%
\begin{equation}
 \label{eq:general:ray_onedir}
 \tilde \gamma: T \times U \Lto C_{\mathrm{pw}}^1\big([0,\infty), \RR^d\big),\quad \tilde \gamma(t,u) = \gamma\big(t, u, N(t,u)\big).
\end{equation}
%
%
Let now $\Omega \subset \RR^D$ be a suitable set and $\big(\SPCH_j, \INNER{\cdot}{\cdot}_j\big)$, $j=1,2$ be Hilbert spaces. In this 
setting, we can study forward operators of the form
%
\begin{align}
 & \OPA: \SPCH_1(\Omega) \Lto \SPCH_2(T \times U) \notag \\
 \label{eq:general:fwdproj}
 & \OPA f(t, u) = \int_{P(t, u)} \int_{\gamma(t, u, \theta) \cap \Omega} f \, \D \gamma\, \D \theta.
\end{align}
%
which maps a pair of parameters $(t, u)$ to the integral of $f$ along all rays arriving at $X(t, u)$. For $L^2$ spaces, we want to 
calculate the adjoint operator:
%
\begin{align}
 \INNER{\OPA f}{g}_2 
 &= \int_T \int_U \OPA f(t, u)\, g(t, u)\, \D u\, \D t \notag \\
 &= \int_T \int_U \int_{P(t, u)} \int_{\gamma(t, u, \theta) \cap \Omega} f \, \D \gamma\, \D \theta\, g(t, u)\, \D u\, \D t \notag \\
 \label{eq:general:backproj_calculation_step1}
 &= \int_T \int_U \int_{P(t, u)} \int_0^\infty  [f \circ \gamma(t, u, \theta)](s)\, \ABS{\gamma(t, u, \theta)'(s)}\, g(t, u)\, \D s\, 
 \D \theta\, \D u\, \D t.
\end{align}
%
We first consider the case where $P(t,u) = \lbrace N(t,u)\rbrace$, i.e. there is exactly one ray arriving at each detector point 
$X_t(u)$ with incoming direction $N_t(u)$. For fixed $t \in T$, we assume that for each $x \in \Omega$, there is a unique ray 
$\tilde \gamma_t(u) = \tilde \gamma_t(u; x)$ containing the point $x$ exactly once, i.e. $\tilde \gamma_t(u; x)(s(x)) = x$. Thus, we can 
define a 
mapping
%
\begin{equation*}
 \Gamma_t: \Omega \to [0, \infty) \times U,\quad x \mapsto (s, u) \text{ with } \tilde \gamma_t(u)(s) = x,
\end{equation*}
%
which is the inverse of the mapping $(s,u) \mapsto \tilde \gamma_t(u)(s)$. The point $X_t\big(u(x)\big)$ can be interpreted as the 
projection of 
$x$ to the detector surface along the corresponding ray, and $s(x)$ is the arc length along the ray from $x$ to its projection. 
Now we can rewrite the integral \eqref{eq:general:backproj_calculation_step1} as
%
\begin{align*}
 \INNER{\OPA f}{g}_2
 &= \int_T \int_{\Gamma_t(\Omega)} f\big(\Gamma_t^{-1}(s,u)\big) \ABSLR{\partial_s \Gamma_t^{-1}(s,u)}\, g(t, u)\, \D s\, \D u\, 
 \D t  \\
 &= \int_T \int_{\Gamma_t(\Omega)} f\big(\Gamma_t^{-1}(s,u)\big) \ABSLR{\big[\partial \Gamma_t\big(\Gamma_t^{-1}(s,u)\big)\big]_1}^{-1}\, 
 g(t, u)\, \D  s\, \D u\, \D t \\
 &= \int_T \int_\Omega f(x) \ABSLR{\big[\partial \Gamma_t(x)\big]_1}^{-1}\, \ABS{\DET{\partial \Gamma_t(x)}}\, 
 g\big(t, \Pi_{\gamma_t}(x)\big)
 \, \D x\, \D t,
\end{align*}
%
where $[\partial \Gamma_t]_1$ stands for the first column of the Jacobian of $\Gamma_t$ and $\Pi_{\gamma_t}(x) = [\Gamma_t(x)]_2$ is the 
$u$ component of $(s, u) = \Gamma_t(x)$. Note that $\ABS{[\partial \Gamma_t]_1} = 1$ if the rays are parametrized with respect to arc 
length. Hence, the adjoint operator can be written as
%
\begin{equation}
 \label{eq:general:backproj_onedir}
 \DUALOPA g(x) = \int_T \ABSLR{\big[\partial \Gamma_t(x)\big]_1}^{-1}\, \ABS{\DET{\partial \Gamma_t(x)}}\, g\big(t, 
\Pi_{\gamma_t}(x)\big)\, 
 \D t
\end{equation}
%
which is equal to
%
\begin{equation}
 \label{eq:general:backproj_onedir_alt}
 \DUALOPA g(x) = \int_T \ABSLR{\partial_s \Gamma_t^{-1}\big(\Gamma_t(x)\big)}\, 
 \ABS{\DET{\partial \Gamma_t^{-1}\big(\Gamma_t(x)\big)}}^{-1}\, g\big(t, \Pi_{\gamma_t}(x)\big)\, \D t.
\end{equation}
%
If the transformation factors cannot be determined, it is still possible to calculate the adjoint
%
\begin{align}
 \OPA^\#: \SPCH_2(T \times U, w) \Lto \SPCH_1(\Omega) \notag \\
 \label{eq:general:backproj_onedir_weighted}
 \OPA^\# g(x) = \int_T g\big(t, \Pi_{\gamma_t}(x)\big)\, \D t
\end{align}
%
on the weighted image space $\SPCH_2$ with unknown weight $w: T \times U \to [0, \infty)$.%
\vspace{5ex}%





\section{Applications}
\label{sec:applications}


\subsection{Parallel geometry}
\label{sec:applications:parbeam}

We consider a flat 2D detector moving on the unit circle in the $x$-$y$ plane, oriented to the center of the circle:
%
\begin{align*}
 & T = [-\phi_0, \phi_0],\quad U = [-l_y, l_y] \times [-l_z, l_z] \\
 & X(\phi, u) = \theta(\phi) + \rho(\phi) \cdot \TRANSP{(0, u_1, u_2)}
\end{align*}
%
with $\phi_0 \in (0, \pi/2]$, $l_y, l_z > 0$ and
%
\begin{align}
 \theta(\phi) &= \TRANSP{(\cos\phi, \sin\phi, 0)}, \\ 
 \rho(\phi) &=
 \begin{pmatrix}
  \cos\phi & -\sin\phi & 0 \\
  \sin\phi & \cos\phi & 0 \\
  0 & 0 & 1
 \end{pmatrix}
 = \big(\theta(\phi) | \theta'(\phi) | e_z\big).
\end{align}
%
The classical X-ray transform in these coordinates for functions on a set $\Omega \subset B_1$ in $\RR^3$ is given by
%
\begin{align}
 &\OPP: L^2(\Omega) \Lto L^2(T \times U), \notag \\
 \label{eq:parflat:fwdproj}
 &\OPP f(\phi, u) = \int_\RR f\big(s\theta(\phi) + u_1 \theta'(\phi) + u_2 e_z\big)\, \D s,
\end{align}
%
and its adjoint is the backprojection
%
\begin{equation}
 \label{eq:parflat:backproj}
 \DUALOPP g(x) = \int_{-\phi_0}^{\phi_0} g\big(\phi, \INNER{x}{\theta'(\phi)}, \INNER{x}{e_z}\big)\, \D \phi.
\end{equation}
%
In our common framework, the directional mapping is given by $N(\phi, u) = -\theta(\phi)$, which is the negative of the canonical normal 
$N = \eta_1 \times \eta_2$ with $\eta_j = \partial_{u_j} X / \ABS{\partial_{u_j} X}$. It is $P(\phi, u) = \lbrace N(\phi, u)\rbrace$.
The rays are straight lines, and their formula is (leaving out the ``$\,\widetilde{\ }\,$'' to simplify notation)
%
\begin{equation*}
 \gamma_\phi(u) = \big( s \mapsto X(\phi, u) + (1-s) N(\phi, u),\ s > 0 \big).
\end{equation*}
%
They start at the far end of the object support $\Omega$ and continue to the detector, hence the integration domain of the $s$ 
integral can be extended to $\RR$. Thus, we get the transform
%
\begin{align*}
 \OPP: L^2(B_1) & \Lto L^2(T \times U) \\
 \OPP f(\phi, u) 
 &= \int_{\gamma_\phi(u)} f\, \D \gamma \\
 &= \int_0^\infty f\big(X(\phi, u) + (1-s) N(\phi, u)\big)\, \D s \\
 &= \int_\RR f\big(s \theta(\phi) + \rho(\phi) \cdot \TRANSP{(u_1, 0, u_2)}\big)\, \D s,
\end{align*}
%
which is \eqref{eq:parflat:fwdproj}. To compare the adjoint obtained by the generic formula \eqref{eq:general:backproj_onedir} with 
\eqref{eq:parflat:backproj}, we observe that we can write $x \in \Omega$ as
%
\begin{align*}
 x 
 &= \INNER{x}{\theta(\phi)}\, \theta(\phi) + \big(x - \INNER{x}{\theta(\phi)}\, \theta(\phi)\big) \\
 &= \INNER{x}{\theta(\phi)}\, \theta(\phi) + \INNER{x}{\theta'(\phi)}\, \theta'(\phi) + \INNER{x}{e_z}\, e_z \\
 &= \INNER{x}{\theta(\phi)}\, \theta(\phi) + \rho(\phi) \TRANSP{\big(\INNER{x}{\theta'(\phi)}, 0, \INNER{x}{e_z}\big)}.
\end{align*}
%
This means that for $s = 1 - \INNER{x}{\theta(\phi)}$ and $u = \TRANSP{\big(\INNER{x}{\theta'(\phi)}, \INNER{x}{e_z}\big)}$, it is 
$x = \gamma\big(\phi, u, N(\phi, u)\big)(s)$, and thus the mapping $\Gamma_\phi$ can be explicitly determined as
%
\begin{equation*}
 \Gamma_\phi(x) = \TRANSP{\big(1 - \INNER{x}{\theta(\phi)}, \INNER{x}{\theta'(\phi)}, \INNER{x}{e_z}\big)}
\end{equation*}
%
The Jacobian of this coordinate transform is apparently a column permutation of $\rho(\phi)$, hence the additional factors in the integral 
\eqref{eq:general:backproj_onedir} are one, and we can conclude that
%
\begin{equation*}
 \DUALOPP g(x) = \int_{-\phi_0}^{\phi_0} g\big(\phi, \INNER{x}{\theta'(\phi)}, \INNER{x}{e_z}\big)\, \D\phi,
\end{equation*}
%
which is the same as \eqref{eq:parflat:backproj}.%
\vspace{5ex}%



\subsection{Fan beam geometry}
\label{sec:applications:fanbeam}

\subsubsection{Curved detector}
\label{sec:applications:fanbeam:curved}

Here, we consider the case of 2D functions on $\Omega = B_1 \subset \RR^2$. The detector is a segment of a circle with radius $R > 1$ and 
detects rays coming from a point source on the opposite side of a smaller circle with radius $r$. We write $R = \beta r$, $\beta \geq 1$ 
and parametrize the detector as follows:
%
\begin{align*}
 & T = [0, \phi_0],\quad U = [-\psi_0, \psi_0] \\
 & X(\phi, \psi) = -(R - r) \theta(\phi) + R \theta(\phi + \psi) = -(\beta - 1) r \theta(\phi) + \beta r \theta(\phi + \psi),
\end{align*}
%
with $\theta(\phi) = (\cos\phi, \sin\phi)$ and parameters $\phi_0 \in (0, 2\pi]$ and $\psi_0 \in (0, \pi/2]$. The mathematical model 
for X-ray tomography in this setting is the divergent beam transform
%
\begin{align}
 &\OPD: L^2(\Omega) \Lto L^2(T \times U) \notag\\
 \label{eq:fancurved:fwdproj_otherangle}
 &\OPD f(\phi, \psi) = \int_0^\infty f\big(x_{\mathrm{S}}(\phi) + s \theta(\phi + \tilde\psi)\big)\, \D s
\end{align}
%
with the source position $x_{\mathrm{S}} = -r \theta(\phi)$ and the directional vectors $\theta(\phi) = (\cos\phi, \sin\phi)$. Here, 
$\tilde\psi$ is the angle between $\theta(\phi)$ and the line from the source to the detector point $X(\phi, \psi)$. By means of simple 
geometry, one can show that $2r \tilde\psi = R\psi$, i.e. we have
%
\begin{equation}
 \label{eq:fancurved:fwdproj_realangle}
 \OPD f(\phi, \psi) = \int_0^\infty f\big(x_{\mathrm{S}}(\phi) + s \theta(\phi + \beta\psi/2)\big)\, \D s.
\end{equation} 
%
Now we derive its relation to the 2D parallel beam X-ray transform
%
\begin{align}
 &\OPP: L^2(B_1) \Lto L^2([0,2\pi) \times [-r,r]) \notag \\
 \label{eq:fancurved:xray_fwdproj}
 &\OPP f(\phi, \tau) = \int_\RR f\big(s\theta(\phi) + \tau \theta'(\phi)\big)\, \D s,
\end{align} 
%
with $\theta'(\phi) = \TRANSP{(-\sin\phi, \cos\phi)}$. Its adjoint is
%
\begin{equation}
 \label{eq:fancurved:xray_backproj}
 \DUALOPP g(x) = \int_0^{2\pi} g\big(\phi, \INNER{x}{\theta'(\phi)}\big)\, \D\phi.
\end{equation} 
%
We have
%
\begin{align*}
 \OPD f(\phi, \psi) 
 &= \int_\RR f\big(- r\theta(\phi) + s \theta(\phi + \beta\psi/2)\big)\, \D s \\
 &= \int_\RR f\big(s \theta(\phi + \beta\psi/2) - r \Pi_{\theta(\phi + \beta\psi/2)}\theta(\phi) \big)\, \D s,
\end{align*}
%
and the projection $\Pi_{\theta(\phi + \beta\psi/2)}\theta(\phi)$ can be calculated as
%
\begin{align*}
 \Pi_{\theta(\phi + \beta\psi/2)}\theta(\phi)
 &= \theta(\phi) - \INNER{\theta(\phi)}{\theta(\phi + \beta\psi/2)}\, \theta(\phi + \beta\psi/2) \\
 &=
 \begin{pmatrix}
  \cos\phi - \cos(\psi/2)\, \cos(\phi + \beta\psi/2) \\
  \sin\phi - \cos(\psi/2)\, \sin(\phi + \beta\psi/2)
 \end{pmatrix} \\
 &=
 \begin{pmatrix}
  \sin(\phi + \beta\psi/2)\, \sin(\beta\psi/2) \\
  -\cos(\phi + \beta\psi/2)\, \sin(\beta\psi/2)
 \end{pmatrix} \\
 &= -\sin(\beta\psi/2)\, \theta'(\phi + \beta\psi/2)
\end{align*}
%
and thus 
%
\begin{align*}
 \OPD f(\phi, \psi)
 &= \int_\RR f\big(s \theta(\phi + \beta\psi/2) + r \sin(\beta\psi/2)\, \theta'(\phi + \beta\psi/2) \big)\, \D s \\
 &= \OPP f\big(\phi + \beta\psi/2, r\sin(\beta\psi/2)\big) \\
 &= \OPU \OPP f(\phi, \psi)
\end{align*}
%
with the transform
%
\begin{align}
 &\OPU: L^2\big([0,2\pi) \times [-r,r]\big) \Lto L^2\big([0,\phi_0] \times [-\psi_0,\psi_0]\big) \notag \\
 \label{eq:fancurved:unit_trafo}
 &\OPU g(\phi, \psi) = g\big(\phi + \beta\psi/2, r\sin(\beta\psi/2)\big).
\end{align} 
%
To compute its adjoint, we apply the substitution $\tau = r\sin(\beta\psi/2),\ \D\tau = \sqrt{r^2-\tau^2}\, \beta/2\, \D \psi$ and get
%
\begin{align*}
 \INNER{\OPU g}{h} 
 &= \int_0^{\phi_0} \int_{-\psi_0}^{\psi_0} g\big(\phi + \beta\psi/2, r\sin(\beta\psi/2)\big)\, h(\phi, \psi)\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-\psi_0}^{\psi_0} g\big(\phi + \beta\psi/2, r\sin(\beta\psi/2)\big)\, h_0(\phi, \psi)\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-\psi_0}^{\psi_0} g\big(\phi, r\sin(\beta\psi/2)\big)\, h_0(\phi - \beta\psi/2, \psi)\, \D\phi\, \D\psi \\
 &= \int_0^{2\pi} \int_{-r\sin(\beta\psi_0/2)}^{r\sin(\beta\psi_0/2)} g(\phi, \tau)\, h_0\big(\phi - \arcsin(\tau/r), 
 2\arcsin(\tau/r)/\beta\big)\, \frac{2}{\beta\sqrt{r^2-\tau^2}} \D\phi\, \D\tau,
\end{align*}
%
where
%
\begin{equation*}
 h_0(\phi, \cdot) =
 \begin{cases}
  h(\phi, \cdot) & \text{ if } \phi \in [0,\phi_0] \\
  0 & \text{ else}.
 \end{cases}
\end{equation*}
%
The integration domain $[-r\sin(\beta\psi_0/2), r\sin(\beta\psi_0/2)]$ covers the support of $g = \OPP f$ if the condition
%
\begin{equation}
 \label{eq:fancurved:condition_roi}
 r \sin(\beta\psi_0/2) \geq 1
\end{equation}
%
is fulfilled. In this case, all points in $\Omega$ are covered by rays from each direction, and it is
%
\begin{equation}
 \label{eq:fancurved:unit_trafo_adj_good}
 \DUALOPU h(\phi, \tau) = \frac{2}{\sqrt{r^2-\tau^2}} \, h_0\big(\phi - \arcsin(\tau/r), 2\arcsin(\tau/r)/\beta\big).
\end{equation}
%
Otherwise, the adjoint involves a cutoff,
%
\begin{equation}
 \label{eq:fancurved:unit_trafo_adj_bad}
 \DUALOPU h(\phi, \tau) = \frac{2}{\sqrt{r^2-\tau^2}} \, h_0\big(\phi - \arcsin(\tau/r), 2\arcsin(\tau/r)/\beta\big)\, 
 \chi_{[0, r\sin(\beta\psi_0/2)]}(\ABS{\tau}).
\end{equation}
%
Thus, if \eqref{eq:fancurved:condition_roi} is fulfilled, it is $\DUALOPD = \DUALOPP\DUALOPU$, i.e.
%
\begin{align}
 \DUALOPD g(x)
 &= \int_0^{2\pi} \DUALOPU g\big(\phi, \INNER{x}{\theta'(\phi)}\big)\, \D\phi \notag\\
 \label{eq:fancurved:backproj}
 &= \int_0^{2\pi} \frac{2}{\beta\sqrt{r^2-\tau(\phi, x)^2}} g_0\left(\phi - \psi(\phi,x)/2, \psi(\phi,x) \right)\, \D\phi,
\end{align}
%
where $\tau(\phi,x) = \INNER{x}{\theta'(\phi)}$ and $\psi(\phi,x) = 2\arcsin\big(\tau(\phi,x)/r\big) / \beta$.\\[1ex]
%
\textbf{Important note:} It is not clear if the following reasoning holds due to the $x$-dependent ray definition. Even though $s$ does 
not explicitly appear in either one of the formulas \eqref{eq:general:backproj_onedir}--\eqref{eq:general:backproj_onedir_weighted}, it 
implicitly does in the evaluation point of the functional determinant.\\[1ex]
%
We now apply the unified theory to compare the results. For the directional field $N$, we already showed that 
$N(\phi,\psi) = -\theta(\phi + \beta\psi/2)$, see \eqref{eq:fancurved:fwdproj_realangle}. As in the parallel geometry, we have 
$P(\phi,\psi) = \lbrace N(\phi,\psi)\rbrace$, and the rays are lines from the far end of the object to the detector. In order to determine 
the adjoint using \eqref{eq:general:backproj_onedir}, we need to find $\Gamma_\phi$ as the inverse of 
$(\psi, s) \mapsto \tilde X(\phi, \psi) + (2r - s) N(\phi,\psi)$. However, since $s$ is only a help variable which does not appear in the 
final formula, we can select any parametrization of a ray through $x$ by arc length. An obvious choice is
%
\begin{equation*}
 \gamma_x(s) = -r \theta(\phi) + s\, \frac{x + r\theta}{\ABS{x + r\theta}}
\end{equation*}
%
from the source point ($s=0$) through $x$ with parameter $s_x=\ABS{x + r\theta}$. If we denote by $\tilde\psi_x$ the angle between this 
ray and  $\theta(\phi)$, we can immediately conclude that
%
\begin{equation*}
 \cos \tilde\psi_x = \frac{\INNER{x + r\theta(\phi)}{\theta(\phi)}}{\ABS{x + r\theta(\phi)}} 
 = \frac{r + \INNER{x}{\theta(\phi)}}{\sqrt{\ABS{x}^2 + r^2 + 2r \INNER{x}{\theta(\phi)}}}.
\end{equation*}
%
The same argument as in the derivation of \eqref{eq:fancurved:fwdproj_realangle} yields the corresponding detector angle
%
\begin{equation}
 \label{eq:fancurved:psi_x}
 \psi_x = \frac{2}{\beta}\, \arccos\left( \frac{r + \INNER{x}{\theta(\phi)}}{\sqrt{\ABS{x}^2 + r^2 + 2r \INNER{x}{\theta(\phi)}}} \right).
\end{equation}
%
Now it remains to calculate the functional determinant of the change of coordinates $(\psi, s) \to x$. In an intermediate step, we set 
$\mu_x = \cos \tilde\psi_x$ and get the functional determinant
%
\begin{equation*}
 \DET \frac{\partial(\mu_x, s_x)}{\partial x} = - \frac{\INNER{x}{\theta'(\phi)}}{\ABS{x + r \theta(\phi)}^3}.
\end{equation*}
%
Furthermore, it is
%
\begin{equation*}
 \frac{\D \tilde\psi_x}{\D \mu_x}\big(\mu_x\big) = \arccos'(\mu_x) = - \frac{1}{\sqrt{1 - \mu_x^2}}.
\end{equation*}
%
This expression can be simplified as follows:
%
\begin{align*}
 1 - \mu_x^2 
 &= \frac{\ABS{x + r\theta(\phi)}^2 - \big(\INNER{x}{\theta(\phi)} + r\big)^2}{\ABS{x + r\theta(\phi)}^2} \\
 &= \frac{\ABS{x}^2 + 2r \INNER{x}{\theta(\phi)} + r^2 - \INNER{x}{\theta(\phi)}^2 - 2r\INNER{x}{\theta(\phi)} - r^2}{\ABS{x + 
 r\theta(\phi)}^2} \\
 &= \frac{\ABS{x}^2 - \INNER{x}{\theta(\phi)}^2}{\ABS{x + r\theta(\phi)}^2} \\
 &= \frac{\INNER{x}{\theta'(\phi)}^2}{\ABS{x + r\theta(\phi)}^2}.
\end{align*}
%
Hence, with the chain rule, we get
%
\begin{equation*}
 \ABSLR{\DET \frac{\partial(\tilde\psi_x, s_x)}{\partial x} (x)} = \ABSLR{\DET \frac{\partial(\mu_x, s_x)}{\partial x} (x)} \cdot
 \ABSLR{\frac{\D \tilde\psi_x}{\D \mu_x}\big(\mu_x\big)} = \frac{1}{\ABS{x + r\theta(\phi)}^2}.
\end{equation*}
%
The transition from $\tilde\psi_x$ to $\psi_x$ introduces a factor $2/\beta$, and the adjoint can be finally written as
%
\begin{equation}
 \label{eq:fancurved:backproj_alt}
 \OPD^* g(x) = \int_0^{\phi_0} \frac{2}{\beta \ABS{x + r\theta(\phi)}^2}\, g\big(\phi, \psi(\phi, x)\big)\, \D \phi
\end{equation}
%
with $\psi(\phi, x) = \psi_x$ as defined in \eqref{eq:fancurved:psi_x}. It is not obvious that this formula is equivalent to 
\eqref{eq:fancurved:backproj}.
\vspace{5ex}%



\subsubsection{Flat detector}
\label{sec:applications:fanbeam:flat}

The situation with a flat detector can be reduced to the curved detector setting with $R = 2r$. Here, we have the parameter sets
%
\begin{equation}
 \label{eq:fanflat:params}
 T = [0, \phi_0], \quad U = [-l, l]
\end{equation}
%
for the parametrization
%
\begin{equation*}
 X(\phi, \tau) = - r \theta(\phi) + 2 r \theta\big(\phi + \psi(\tau)\big)
\end{equation*}
%
of the detector. The relation between the detector coordinate $\tau$ and the angle between the central ray and the ray to the detector 
position defined by $\tau$ is given by the relation
%
\begin{equation*}
 \tan\psi = \frac{\tau}{2r},
\end{equation*}
%
hence the detector parametrization is
%
\begin{equation}
 \label{eq:fanflat:detector_parametr}
 X(\phi, \tau) = - r \theta(\phi) + 2 r \theta\big(\phi + \arctan(\tau/2r)\big).
\end{equation}
%
The directional field $N$ can be read off this definition as
%
\begin{equation}
 \label{eq:fanflat:dirfield}
 N(\phi, \tau) = -\theta\big(\phi + \arctan(\tau/2r)\big).
\end{equation} 
%
Alternatively, we can parametrize the detector as
%
\begin{equation}
 \label{eq:fanflat:detector_parametr_alt}
 X(\phi, \tau) = r \theta(\phi) + \tau \theta'(\phi),\quad \theta'(\phi) = \TRANSP{(-\sin\phi, \cos\phi)}.
\end{equation}
%
If we denote with $\OPD_{\mathrm{c}}$ the divergent beam transform \eqref{eq:fancurved:fwdproj_realangle} with $\beta=2$, the flat detector 
transform
%
\begin{align}
 &\OPD: L^2(\Omega) \Lto L^2(T \times U) \notag \\
 \label{eq:fanflat:fwdproj}
 &\OPD f(\phi, \tau) = \int_0^\infty f\left(-r \theta(\phi) + s \theta\big(\phi + \arctan(\tau/2r)\big) \right)\, \D s
\end{align}
%
can be expressed as a transformed version of $\OPD_{\mathrm{c}}$:
%
\begin{equation*}
 \OPD f(\phi, \tau) = \OPD_{\mathrm{c}} f\big(\phi,  \arctan(\tau/2r)\big) = \OPT \OPD_{\mathrm{c}} f(\phi, \tau)
\end{equation*}
%
with
%
\begin{equation*}
 \OPT: L^2\big([0, \phi_0] \times [-\psi_0, \psi_0]) \Lto L^2\big([0, \phi_0] \times [-l, l]\big), \quad \psi_0 = \arctan(l/2r).
\end{equation*}
%
Its adjoint can be determined with the coordinate change $\psi = \arctan(\tau/2r),\ \D\psi = \cos^2\psi / 2r\, \D\tau$ from
%
\begin{align*}
 \INNER{\OPT g}{h} 
 &= \int_0^{\phi_0} \int_{-l}^l g\big(\phi, \arctan(\tau/2r)\big)\, h(\phi, \tau)\, \D\tau\, \D\phi \\
 &= \int_0^{\phi_0} \int_{-\psi_0}^{\psi_0} g(\phi, \psi)\, h(\phi, 2r\tan\psi)\, \frac{2r}{\cos^2\psi} \D\psi\, \D\phi,
\end{align*}
%
i.e.
%
\begin{equation}
 \label{eq:fanflat:curved2flat_adj}
 \DUALOPT h(\phi, \psi) = h(\phi, 2r\tan\psi)\, \frac{2r}{\cos^2\psi}.
\end{equation} 
%
\NOTE{TODO: formulate condition on $l$}%
Using the expression \eqref{eq:fancurved:backproj} for $\DUAL{\OPD_{\mathrm{c}}}$, we conclude that
%
\begin{align}
 \DUALOPD g(x) 
 &= \int_0^{2\pi} \frac{1}{\sqrt{r^2-\tau(\phi, x)^2}} (\DUALOPT g)_0\left(\phi - \psi(\phi,x)/2, \psi(\phi,x) \right)\, \D\phi 
 \notag \\
 \label{eq:fanflat:backproj}
 &= \int_0^{2\pi} \frac{2r}{\cos^2\big(\psi(\phi,x)\big)\sqrt{r^2-\tau(\phi, x)^2}}\,
 g_0\left(\phi - \psi(\phi,x)/2, 2r \tan\big(\psi(\phi,x)\big) \right)\, \D\phi 
\end{align} 
%\vspace{5ex}%



\subsection{Cone beam geometry -- circular acquisition}
\label{sec:applications:cone_circular}

\subsubsection{Two-fold curved detector}
\label{sec:applications:cone_circular:twofoldcurved}

In this setting, we consider a detector which is curved both horizontally and vertically, but with possibly different curvatures. Let
%
\begin{equation}
 \label{eq:conecurved:unitvecs}
 \theta(\phi) = \TRANSP{(\cos\phi, \sin\phi, 0)}, \quad \theta(\phi) = \TRANSP{(-\sin\phi, \cos\phi, 0)}, \quad e_z = \TRANSP{(0, 0, 1)}.
\end{equation}
%
be the unit vectors in the rotating system. The detector is parametrized over the sets
%
\begin{equation}
 \label{eq:conecurved:params}
 T = [0, \phi_0],\quad U = [-\psi_0, \psi_0] \times [-\vartheta_0, \vartheta_0],
\end{equation}
%
and is assumed to have curvature $1/R_1$ along $\theta'(\phi)$ and $1/R_2$ along $e_z$ with $R_1,R_2 >0$. From the 2D case, we know that 
for $\theta=0$, the detector point associated with $\phi$ and $\psi$ is
%
\begin{equation*}
 d_1 = c_1 + R_1 \theta(\phi + \psi), \quad c_1 = -(R_1 - r) \theta(\phi).
\end{equation*}
%
If $\theta \neq 0$, the detector point is given by a second rotation applied to $d_1$, the center of rotation being $c_2 = -(R_2 - r) 
\theta(\phi)$ and the rotation axis being $-\theta'(\phi)$. This rotation can be generally expressed as
%
\begin{equation*}
 x \mapsto c_2 + \rho(x - c_2), \quad \rho(x) = \INNER{x}{\theta'}\, \theta' + \cos\vartheta \big(x - \INNER{x}{\theta'}\, \theta'\big) 
 - \sin\vartheta\, (\theta' \times x)
\end{equation*}
%
with the cross product $\times$ in $\RR^3$. Using the relations
%
\begin{align*}
 \theta'(\phi) \times \theta(\phi) &= -e_z, \\
 e_z \times \theta'(\phi) &= -\theta(\phi), \\
 \INNER{\theta(\phi + \psi)}{\theta'(\phi)} &= \sin\psi \\
 \theta(\phi + \psi) - \INNER{\theta(\phi + \psi)}{\theta'(\phi)}\, \theta'(\phi) &= \cos\psi\, \theta(\phi)\\
 \theta'(\phi) \times \theta(\phi + \psi) &= -\cos\psi\, e_z.
\end{align*}
%
and inserting $x = d_1$, we get the detector point
%
\begin{align}
 X(\phi, \psi, \theta)
 &= c_2 + \rho(d_1 - c_2) \notag \\
 &= -(R_2 - r) \theta(\phi) + \rho\big(c_1 + R_1 \theta(\phi + \psi) - c_2\big) \notag \\
 &= -(R_2 - r) \theta(\phi) + \rho\big((R_2-R_1) \theta(\phi) + R_1 \theta(\phi + \psi)\big) \notag \\
 &= -(R_2 - r) \theta(\phi) + (R_2-R_1) \rho\big(\theta(\phi)\big) + R_1 \rho\big(\theta(\phi + \psi)\big) \notag \\
 &= -(R_2 - r) \theta(\phi) + (R_2-R_1) \big[ \cos\vartheta\, \theta(\phi) + \sin\vartheta\, e_z \big] + \phantom{x} \notag \\
 &\hspace{25pt} R_1 \big[ \sin\psi\, \theta'(\phi) + \cos\vartheta\, \cos\psi\, \theta(\phi) + \sin\vartheta\, \cos\psi\, e_z \big] \notag 
 \\
 &= \big[ -(R_2 - r) + (R_2 - R_1) \cos\vartheta + R_1 \, \cos\vartheta\, \cos\psi \big]\, \theta(\phi) + \phantom{x} \notag \\
 &\hspace{14pt} \big[R_1 \sin\psi\big]\, \theta'(\phi) + \big[ (R_2 - R_1) \sin\vartheta + R_1\, \sin\vartheta\, \cos\psi \big]\, e_z 
\notag  \\
 \label{eq:conecurved:detector_parametr}
 &= \big[ r - 2R_2 \sin^2(\vartheta/2) - 2R_1 \cos\vartheta \sin^2(\psi/2) \big]\, \theta(\phi) + \big[R_1 \sin\psi\big]\, 
 \theta'(\phi) + \phantom{x} \\
 &\hspace{14pt} \big[ -2R_1 \sin\vartheta\sin^2(\psi/2) + R_2\sin\vartheta \big]\, e_z \notag 
\end{align}
%
\NOTE{Check if this makes sense -- especially if the $z$ component can really depend on $\psi$!}%
The two rotations with respect to the angles $\psi$ and $\vartheta$ are independent, thus the result from the 2D case on the relation 
between detector angles and angles as seen from the source point holds for both $\psi$ and $\vartheta$ separately. It follows immediately 
that the directions from the detector to the source are given by
%
\begin{equation}
 \label{eq:conecurved:direction_field}
 N(\phi, \psi, \vartheta) = -\omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2)
\end{equation} 
%
with $R_j = \beta_j r,\ j=1,2$ and the unit vector
%
\begin{equation}
 \label{eq:conecurved:unitvec_omega}
 \omega(\phi, \theta) = \TRANSP{(\cos\vartheta \cos\phi, \cos\vartheta\sin\phi, \sin\vartheta)}.
\end{equation} 
%
Now we define the 3D divergent beam transform for functions on $\Omega = B_1 \subset \RR^3$:
%
\begin{align}
 &\OPD: L^2(\Omega) \Lto L^2(T \times U) \notag \\
 \label{eq:conecurved:fwdproj}
 &\OPD f(\phi, \psi, \vartheta) = \int_0^\infty f\big( -r\theta(\phi) + s\omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2) \big)\, \D s.
\end{align}
%
To relate this operator to the parallel beam X-ray transform, we need to calculate the projection of $\theta(\phi)$ onto
$\omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2)$. For angles $\phi$ and $\vartheta$, the canonical basis in 
$\omega(\phi, \vartheta)^\perp$ is given by the normalized derivatives with respect to $\phi$ and $\vartheta$, respectively. These vectors 
are
%
\begin{align}
 \label{eq:conecurved:omega1perp}
 \omega_1^\perp(\phi, \vartheta) &= \theta'(\phi), \\
 \label{eq:conecurved:omega2perp}
 \omega_2^\perp(\phi, \vartheta) &= -\sin\vartheta\, \theta(\phi) + \cos\vartheta\, e_z.
\end{align}
%
Thus, we can write
%
\begin{align*}
 \Pi_{\omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2)} \theta(\phi)
 &= \INNER{\theta(\phi)}{\theta'(\phi + \beta_1\psi/2)}\, \omega_1^\perp + \phantom{x} \\
 &\hspace{14pt} \INNER{\theta(\phi)}{-\sin(\beta_2\vartheta/2)\, \theta(\phi + \beta_1\psi/2) + \cos(\beta_2\vartheta/2)\, e_z}\, 
 \omega_2^\perp \\
 &= -\sin(\beta_1\psi/2)\, \omega_1^\perp - \cos(\beta_1\psi/2) \sin(\beta_2\vartheta/2)\, \omega_2^\perp.
\end{align*}
%
In consequence,
%
\begin{align*}
 \OPD f(\phi, \psi, \vartheta)
 &= \int_\RR f\big( s\omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2) + r\sin(\beta_1\psi/2)\, \omega_1^\perp + 
 r \cos(\beta_1\psi/2) \sin(\beta_2\vartheta/2)\, \omega_2^\perp \big)\, \D s \\
 &= \OPP f\big(\phi + \beta_1\psi/2, \beta_2\vartheta/2, r\sin(\beta_1\psi/2), r \cos(\beta_1\psi/2) \sin(\beta_2\vartheta/2) \big) \\
 &= \OPU \OPP f(\phi, \psi, \vartheta)
\end{align*}
%
with the 3D X-ray transform
%
\begin{align}
 &\OPP: L^2(\Omega) \Lto L^2\big( [0, 2\pi) \times [-\pi/2, \pi/2] \times \RR^2 \big) \notag \\
 \label{eq:conecurved:xray_proj}
 &\OPP f(\phi, \vartheta, \sigma, \tau) = \int_\RR f(s \omega(\phi, \vartheta) + \sigma \omega_1^\perp + \tau \omega_2^\perp \big)\, \D s
\end{align}
%
and the coordinate transform
%
\begin{align}
 &\OPU: L^2\big( [0, 2\pi) \times [-\pi/2, \pi/2] \times \RR^2 \big) \Lto L^2([0, \phi_0] \times [-\psi_0, \psi_0] \times 
 [-\vartheta_0, \vartheta_0] \big) \notag \\
 \label{eq:conecurved:coord_op}
 &\OPU g(\phi, \psi, \vartheta) = g\big( \phi + \beta_1\psi/2, \beta_2\vartheta/2, r\sin(\beta_1\psi/2), r \cos(\beta_1\psi/2) 
 \sin(\beta_2\vartheta/2) \big).
\end{align}
%
The adjoint of $\OPP$ is the usual parallel beam backprojection
%
\begin{equation}
 \label{eq:conecurved:xray_backproj}
 \DUALOPP g(x) = \int_0^{2\pi} \int_{-\pi/2}^{\pi/2} g\big( \phi, \vartheta, \INNER{x}{\omega_1^\perp(\phi, \vartheta)}, 
 \INNER{x}{\omega_2^\perp(\phi, \vartheta)} \big)\, \D\vartheta\, \D\phi.
\end{equation} 
%
For the operator $\OPU$, we calculate
%
\begin{align*}
 \INNER{\OPU g}{h}
 &= \int_0^{\phi_0} \int_{-\psi_0}^{\psi_0} \int_{-\vartheta_0}^{\vartheta_0} g\big( \phi + \beta_1\psi/2, \beta_2\vartheta/2, 
 r\sin(\beta_1\psi/2), r \cos(\beta_1\psi/2) \sin(\beta_2\vartheta/2) \big) \cdot \phantom{x} \\
 &\hspace{80pt} h(\phi, \psi, \vartheta)\, \D\vartheta\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-\psi_0}^{\psi_0} \int_{-\beta_2\vartheta_0/2}^{\beta_2\vartheta_0/2} g\big( \phi, \vartheta, 
 r\sin(\beta_1\psi/2), r \cos(\beta_1\psi/2) \sin\vartheta \big) \cdot \phantom{x} \\
 &\hspace{95pt} h_0\big( \phi - \beta_1\psi/2, \psi, 2\vartheta/\beta_2 \big)\, 
 \frac{2}{\beta_2}\, \D\vartheta\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-r\sin(\beta_1\psi_0/2)}^{r\sin(\beta_1\psi_0/2)} \int_{-\beta_2\vartheta_0/2}^{\beta_2\vartheta_0/2}
 g\big( \phi, \vartheta, \sigma, \sqrt{r^2 - \sigma^2} \sin\vartheta \big) \cdot \phantom{x} \\
 &\hspace{135pt} h_0\big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\vartheta/\beta_2 \big)\, \cdot \phantom{x} \\
 &\hspace{135pt} \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2}}\, \D\vartheta\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-r\sin(\beta_1\psi_0/2)}^{r\sin(\beta_1\psi_0/2)} \int_{-\beta_2\vartheta_0/2}^{\beta_2\vartheta_0/2} \int_{-r}^r
 g(\phi, \vartheta, \sigma, \tau)\, \delta\big(\tau - \sqrt{r^2 - \sigma^2} \sin\vartheta \big) \cdot \phantom{x} \\
 &\hspace{135pt} h_0\big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\vartheta/\beta_2 \big) \cdot \phantom{x} \\
 &\hspace{135pt} \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2}}\, \D\tau\, \D\vartheta\, \D\sigma\, \D\phi.
\end{align*}
%
The adjoint of $\OPU$ in the sense of unbounded operators can be read off the last identity as
%
\begin{align}
 \label{eq:conecurved:coord_op_adjoint}
 \DUALOPU g(x) 
 &= \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2}}\,
 h_0\big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\vartheta/\beta_2 \big) \cdot \phantom{x} \\
 &\hspace{15pt}\delta\big(\tau - \sqrt{r^2 - \sigma^2} \sin\vartheta \big) \notag.
\end{align} 
%
Since the composition $\OPU \OPP$ is known to 
be bounded, its adjoint is given by $\DUALOPP \DUALOPU$. The $\vartheta$ integration in \eqref{eq:conecurved:xray_backproj} can be reduced 
with the $\delta$ distribution if for each $\tau$ and each $\sigma$ in the respective intervals, there is a $\vartheta$ in the integration 
domain such that $\tau - \sqrt{r^2 - \sigma^2} \sin\vartheta = 0$. Since we insert $\sigma = \INNER{x}{\omega_1^\perp}$ and $\tau = 
\INNER{x}{\omega_2^\perp}$, $\ABS{\tau_{\text{max}}} = 1$ and the minimum of the root is $\sqrt{r^2 - 1}$ or 
$\sqrt{r^2 - \sigma_{\text{max}}^2} = r\cos(\beta_1\psi_0/2)$. Thus, $\vartheta_0$ has to fulfill at least
%
\begin{equation}
 r\sin(\beta_2\vartheta_0/2) \geq \frac{1}{\cos(\beta_1\psi_0/2)}
\end{equation}
%
\NOTE{In fact, it can, but yields identically zero where the integration domain contains no zero of the delta argument.}%
since otherwise, the $\vartheta$ integral cannot be reduced with the $\delta$ distribution. 
The simultaneous conditions on $\psi_0$ and $\vartheta_0$ read as
%
\NOTE{Check if this makes sense. Geometrically, the condition on $\vartheta_0$ should look similar to the one for $\psi_0$.}%
\begin{align}
 r \sin(\beta_1\psi_0/2) &\geq 1 \\
 \sin(\beta_2\vartheta_0/2) &\geq \frac{1}{\sqrt{r^2 - 1}}.
\end{align}
%
Then, the integral over $\vartheta$ can be evaluated using
%
\begin{equation*}
 \delta\big(w(u)\big) = \sum_{u:w(u)=0} \frac{\delta(u)}{\ABS{w'(u)}}.
\end{equation*}
%
If we insert $\DUALOPU g$ into $\DUALOPP$ with the abbreviation $\Phi(\vartheta)$ for the integrand except the delta distribution, we get 
the $\vartheta$ integral
%
\begin{equation}
 \label{eq:conecurved:theta_integral_delta}
 \int_{-\beta_2\vartheta/2}^{\beta_2\vartheta/2} \Phi(\vartheta)\, 
 \delta\left( -\sin\vartheta \INNER{x}{\theta(\phi)} + \cos\vartheta \INNER{x}{e_z} - \sqrt{r^2 - \INNER{x}{\theta'(\phi)}^2} \sin\vartheta 
 \right)\, \D\vartheta.
\end{equation}
%
The zero of the argument $w(\vartheta)$ of $\delta$ can be calculated as
%
\begin{align}
 &\cos\vartheta \INNER{x}{e_z} - \sin\vartheta \Big( \INNER{x}{\theta(\phi)} + \sqrt{r^2 - \INNER{x}{\theta'(\phi)}^2} \Big) = 0 \quad
 \Rightarrow \notag \\
 \label{eq:conecurved:theta_in_delta}
 & \vartheta^* = \vartheta^*(\phi, x) = \arctan \left( \frac{\INNER{x}{e_z}}{\INNER{x}{\theta(\phi)} + \sqrt{r^2 - 
 \INNER{x}{\theta'(\phi)}^2}} \right),
\end{align}
%
and its derivative evaluated at this point is
%
\begin{equation*}
 w'(\vartheta^*) = \left. -\sin\vartheta \INNER{x}{e_z} - \cos\vartheta \Big( \INNER{x}{\theta(\phi)} + \sqrt{r^2 - 
 \INNER{x}{\theta'(\phi)}^2} \Big) \right|_{\vartheta = \vartheta^*}.
\end{equation*}
%
Using the relations $\sin\vartheta = \tan\vartheta / \sqrt{\tan^2\vartheta + 1}$ and $\cos\vartheta = 1 / \sqrt{\tan^2\vartheta + 1}$ and 
the abbreviations $a$ and $b$ for nominator and denumerator of the argument of $\arctan$ in \eqref{eq:conecurved:theta_in_delta}, we get 
\NOTE{Check if signs of $a$ and $b$ matter}%
%
\begin{equation*}
 \sin\vartheta^* = \frac{a}{\sqrt{a^2 + b^2}}, \quad \cos\vartheta^* = \frac{b}{\sqrt{a^2 + b^2}},
\end{equation*}
%
and in consequence
%
\begin{equation*}
 a\sin\vartheta^* + b\cos\vartheta^* = \frac{a^2}{\sqrt{a^2 + b^2}} + \frac{b^2}{\sqrt{a^2 + b^2}} = \sqrt{a^2 + b^2}.
\end{equation*}
%
The $\vartheta$ integral \eqref{eq:conecurved:theta_integral_delta} can thus be resolved to
%
\begin{equation*}
 \Phi\big(\arctan(a/b)\big) / \sqrt{a^2 + b^2}.
\end{equation*}
%
In total, we get the representation
%
\begin{align}
 \label{eq:conecurved:backproj}
 \DUALOPD g(x)
 &= \int_0^{2\pi} \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2} \sqrt{a^2 + b^2}} \cdot \phantom{x} \\
 &\hspace{35pt} g_0 \big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\arctan(a/b)/\beta_2 \big)\, \D\phi \notag
\end{align}
%
with
%
\begin{align}
 \label{eq:conecurved:bp_sigma}
 \sigma &= \sigma(\phi, x) = \INNER{x}{\theta'(\phi)}, \\
 \label{eq:conecurved:bp_a}
 a &= a(x) = \INNER{x}{e_z}, \\
 \label{eq:conecurved:bp_b}
 b &= b(\phi, x) = \INNER{x}{\theta(\phi)} + \sqrt{r^2 - \sigma(\phi,x)^2}.
\end{align}
\vspace{5ex}%


\subsubsection{Detector curved only along $\phi$}
\label{sec:applications:cone_circular:curvedstack}

These detectors are probably the most common ones in medical imaging. They consist in curved line detectors stacked along the vertical 
axis. We set $R = R_1$ and $\beta = \beta_1$ for the corresponding quantities along $\phi$ in section 
\ref{sec:applications:cone_circular:twofoldcurved}. The detector is parametrized over the sets
%
\begin{equation}
 \label{eq:conestack:params}
 T = [0, \phi_0],\quad U = [-\psi_0, \psi_0] \times [-h, h]
\end{equation}
%
with $h>0$ and has the representation
%
\begin{equation}
 \label{eq:conestack:detector_parametr}
 X(\phi, \psi, z) = -(R - r)\, \theta(\phi) + R\, \theta(\phi + \psi) + \arctan(z/2r)\, e_z.
\end{equation}
%
The directional field can be written, analogously to \eqref{eq:fanflat:dirfield}, as
%
\begin{equation}
 \label{eq:conestack:dirfield}
 N(\phi, \psi, z) = -\theta\big( \phi + \beta\psi/2, \arctan(z/2r) \big),
\end{equation} 
%
and the corresponding forward projection is
%
\begin{align}
 &\OPD: L^2(\Omega) \Lto L^2(T \times U) \notag \\
 &\OPD f(\phi, \psi, z) = \int_0^\infty f\left( -r\theta(\phi) + s \theta\big( \phi + \beta\psi/2, \arctan(z/2r) \big) \right)\, \D s.
\end{align}
%
We use its relation to the two-folded curved operator $\OPD_{\mathrm{TC}}$ as defined in \eqref{eq:conecurved:fwdproj} with $\beta_2 = 2$. 
It is
%
\begin{equation*}
 \OPD f(\phi, \psi, z) = \OPD_{\mathrm{TC}} f\big(\phi, \psi, \tan(z/2r)\big) = \OPT \OPD_{\mathrm{TC}} f(\phi, \psi, z)
\end{equation*}
%
with
%
\begin{equation}
 \label{eq:conestack:curved2flat}
 \OPT g(\phi, \psi, z) = g\big(\phi, \psi, \tan(z/2r)\big).
\end{equation}
%
\NOTE{TODO: formulate the condition on $h$}%
Similarly to \eqref{eq:fanflat:curved2flat_adj}, the adjoint of $\OPT$ is
%
\begin{equation}
 \label{eq:conestack:curved2flat_adj}
 \DUALOPT g(\phi, \psi, \vartheta) = g(\phi, \psi, 2r\tan\vartheta)\, \frac{2r}{\cos^2\vartheta}.
\end{equation}
%
Thus, by inserting $\DUALOPT g$ into \eqref{eq:conecurved:backproj} and using $1/\cos^2 = 1 + \tan^2$, we get the backprojection
%
\begin{align}
 \label{eq:conestack:backproj}
 \DUALOPD g(x)
 &= \int_0^{2\pi} \frac{4r \sqrt{a^2 + b^2}}{\beta b^2 \sqrt{r^2 - \sigma^2}} \cdot \phantom{x} \\
 &\hspace{35pt} g_0 \big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta, 2r\, a/b \big)\, \D\phi \notag
\end{align}
%
with $\sigma, a, b$ as in \eqref{eq:conecurved:bp_sigma}--\eqref{eq:conecurved:bp_b}.
\vspace{5ex}%




\subsubsection{Flat detector}
\label{sec:applications:cone_circular:flat}

This type of detector is mostly used in nondestructive testing. We parametrize it over the sets
%
\begin{equation}
 \label{eq:coneflat:params}
 T = [0, \phi_0], \quad U = [-l, l] \times [-h, h]
\end{equation}
%
by
%
\begin{equation}
 \label{eq:coneflat:detector_parametr}
 X(\phi, \tau, z) = r\theta(\phi) + \tau\, \theta'(\phi) + z\, e_z.
\end{equation} 
%
We can directly write down the direction vectors
%
\begin{equation}
 \label{eq:coneflat:direction_field}
 N(\phi, \tau, z) = - \omega\big(\phi + \arctan(\tau/2r), \arctan(z/2r)\big)
\end{equation}
%
and the corresponding forward projection
%
\begin{align*}
 &\OPD: L^2(\Omega) \Lto L^2(T \times U) \\
 \label{eq:coneflat:fwdproj}
 &\OPD f(\phi, \tau, z) = \int_0^\infty f\left( -r\theta(\phi) + s \omega\big(\phi + \arctan(\tau/2r), \arctan(z/2r)\big) \right) \D s.
\end{align*}
%
By repeating the argument from section \ref{sec:applications:cone_circular:curvedstack} and using
%
\begin{equation*}
 \arcsin x = \arctan\left( \frac{x}{\sqrt{x^2 - 1}} \right),
\end{equation*}
%
we can write the adjoint of $\OPD$ as
%
\begin{align}
 \label{eq:conestack:backproj}
 \DUALOPD g(x)
 &= \int_0^{2\pi} \frac{4r^3 \sqrt{a^2 + b^2}}{b^2 c^3} g_0 \big( \phi - \arcsin(\sigma/r), 2r \sigma/c, 2r\, a/b \big)\, \D\phi \notag
\end{align}
%
with $c = c(\phi, x) = \sqrt{r^2 - \sigma(\phi, x)^2}$ and the usual definitions of $\sigma, a, b$.
\vspace{5ex}%




\subsection{Cone beam geometry -- helical acquisition}
\label{sec:applications:cone_helical}

In the helical or spiral geometry, both source and detector move on a helix instead of a circle. We assume the spiral to have constant 
pitch $\tilde p>0$, i.e. a full rotation by $2\pi$ corresponds to a $z$ shift by $\tilde p$. For simpler notation, we write 
$p = \tilde p/(2\pi)$. The source-detector system now executes $k > 0$ instead of one rotation in order to allow for objects which 
are extended in $z$ direction. We account for this situation by setting the domain of the preimage space functions as
%
\begin{equation}
 \label{eq:hcone:cylinderdomain}
 \Omega = B_1 \times [H_1, H_2]
\end{equation}
%
with $B_1 \subset \RR^2$ and $0 < H_1 < H_2$.

\subsubsection{Two-fold curved detector}
\label{sec:applications:cone_helical:twofoldcurved}

We now have the parameter sets
%
\begin{equation}
 \label{eq:hconecurved:params}
 T = [0, 2\pi k], \quad U = [-\psi_0, \psi_0] \times [-\vartheta_0, \vartheta_0].
\end{equation}
%
The detector parametrization can be derived from the circular acquisition situation \eqref{eq:conecurved:detector_parametr} by adding the 
shift $p \phi e_z$:
%
\begin{align}
 \label{eq:hconecurved:detector_parametr}
 X(\phi, \psi, \vartheta)
 &= \big[ r - 2R_2 \sin^2(\vartheta/2) - 2R_1 \cos\vartheta \sin^2(\psi/2) \big]\, \theta(\phi) + \big[-R_1 \sin\psi\big]\, 
 \theta'(\phi) + \phantom{x} \\
 &\hspace{14pt} \big[ -2R_1 \sin\vartheta\sin^2(\psi/2) + R_2\sin\vartheta + p\phi \big]\, e_z \notag 
\end{align}
%
Since both source and detector are shifted simultaneously, the direction field is the same as before,
%
\begin{equation}
 \label{eq:hconecurved:direction_field}
 N(\phi, \psi, \vartheta) = -\omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2),
\end{equation} 
%
but the definition of the forward projection operator changes to
%
\begin{align}
 &\OPD: L^2(\Omega) \Lto L^2(T \times U) \notag \\
 \label{eq:hconecurved:fwdproj}
 &\OPD f(\phi, \psi, \vartheta) = \int_0^\infty f\big(-r\theta(\phi) + p\phi e_z + s \omega(\phi + \beta_1\psi/2, \beta_2\vartheta/2)\big)
 \D s.
\end{align}
%
To relate this operator to the X-ray transform, we again need to calculate the projection of the source point location onto $\omega$. Apart 
from the projection of $\theta(\phi)$ as calculated in section \ref{sec:applications:cone_circular:twofoldcurved}, we also need the 
projection of $e_z$. Using \eqref{eq:conecurved:omega1perp}--\eqref{eq:conecurved:omega2perp}, we see that the unit vector 
$\omega_1^\perp$ gives no contribution, and on the other hand,
%
\begin{equation*}
 \INNER{e_z}{\omega_2^\perp(\phi, \vartheta)} = \cos\vartheta.
\end{equation*}
%
\NOTE{TODO: formulate conditions on $l$ and $h$}%
It can be immediately concluded that
%
\begin{align*}
 \OPD f(\phi, \psi, \vartheta) 
 &= \OPP\big( \phi + \beta_1\psi/2, \beta_2\vartheta/2, r\sin(\beta_1\psi/2), r\cos(\beta_1\psi/2)\sin(\beta_2\vartheta/2) + 
 p\phi \cos(\beta_2\vartheta/2) \big) \\
 &= \OPU \OPP f(\phi, \psi, \vartheta).
\end{align*}
%
This operator $\OPU$ can be treated in the same way as the transform \eqref{eq:conecurved:coord_op}:
%
\begin{align*}
 \INNER{\OPU g}{h}
 &= \int_0^{\phi_0} \int_{-\psi_0}^{\psi_0} \int_{-\vartheta_0}^{\vartheta_0} g\big( \phi + \beta_1\psi/2, \beta_2\vartheta/2, 
 r\sin(\beta_1\psi/2), r \cos(\beta_1\psi/2) \sin(\beta_2\vartheta/2) + \phantom{x} \\
 &\hspace{80pt} p \phi \cos(\beta_2\vartheta/2) \big)\, h(\phi, \psi, \vartheta)\, \D\vartheta\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-\psi_0}^{\psi_0} \int_{-\beta_2\vartheta_0/2}^{\beta_2\vartheta_0/2} g\big( \phi, \vartheta, 
 r\sin(\beta_1\psi/2), r \cos(\beta_1\psi/2) \sin\vartheta + (\phi - \beta_1\psi/2)\, p \cos\vartheta \big) \cdot \phantom{x} \\
 &\hspace{95pt} h_0\big( \phi - \beta_1\psi/2, \psi, 2\vartheta/\beta_2 \big)\, 
 \frac{2}{\beta_2}\, \D\vartheta\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-r\sin(\beta_1\psi_0/2)}^{r\sin(\beta_1\psi_0/2)} \int_{-\beta_2\vartheta_0/2}^{\beta_2\vartheta_0/2}
 g\left( \phi, \vartheta, \sigma, \sqrt{r^2 - \sigma^2} \sin\vartheta + \big(\phi - \arcsin(\sigma/r)\big)\, p \cos\vartheta \right) \cdot 
 \phantom{x} \\
 &\hspace{135pt} h_0\big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\vartheta/\beta_2 \big)\, \cdot \phantom{x} \\
 &\hspace{135pt} \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2}}\, \D\vartheta\, \D\psi\, \D\phi \\
 &= \int_0^{2\pi} \int_{-r\sin(\beta_1\psi_0/2)}^{r\sin(\beta_1\psi_0/2)} \int_{-\beta_2\vartheta_0/2}^{\beta_2\vartheta_0/2} \int_{-r}^r
 g(\phi, \vartheta, \sigma, \tau) \cdot \phantom{x} \\
 &\hspace{145pt} \delta\left( \tau - \sqrt{r^2 - \sigma^2} \sin\vartheta - \big(\phi - \arcsin(\sigma/r)\big)\, p \cos\vartheta \right) 
 \cdot \phantom{x} \\
 &\hspace{145pt} h_0\big( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\vartheta/\beta_2 \big) \cdot \phantom{x} \\
 &\hspace{145pt} \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2}}\, \D\tau\, \D\vartheta\, \D\sigma\, \D\phi.
\end{align*}
%
The delta distribution is reduced with the $\vartheta$ integral as for the circular acquisition, with the same arguments $\sigma$ and 
$\tau$. For the $\delta$ argument, we have
%
\begin{align*}
 w(\vartheta) 
 &= -\sin\vartheta \INNER{x}{\theta(\phi)} + \cos\vartheta \INNER{x}{e_z} - \sqrt{r^2 - \INNER{x}{\theta'(\phi)}^2} \sin\vartheta - 
 \big(\phi - \arcsin(\INNER{x}{\theta'(\phi)}/r)\big)\, p \cos\vartheta \\
 &= -\sin\vartheta \left( \INNER{x}{\theta(\phi)} + \sqrt{r^2 - \INNER{x}{\theta'(\phi)}^2} \right) + 
 \cos\vartheta \left( \INNER{x}{e_z} - p\, \big(\phi - \arcsin(\INNER{x}{\theta'(\phi)}/r)\big) \right)
\end{align*}
%
which has its zero at
%
\begin{equation}
 \label{eq:hconecurved:theta_in_delta}
 \vartheta^*(\phi, x) = \arctan \left( \frac{\INNER{x}{e_z} - p\, \big(\phi - \arcsin(\INNER{x}{\theta'(\phi)}/r)}{\INNER{x}{\theta(\phi)} + 
 \sqrt{r^2 - \INNER{x}{\theta'(\phi)}^2}} \right)
\end{equation} 
%
or in short $\vartheta^* = \arctan\big((a - pd) / b\big)$ with $a, b$ as in \eqref{eq:conecurved:bp_a}--\eqref{eq:conecurved:bp_b} and
%
\begin{equation}
 \label{eq:hconecurved:bp_d}
 d = d(\phi, x) = \big(\phi - \arcsin(\INNER{x}{\theta'(\phi)}/r)\big).
\end{equation}
%
Inserting $\vartheta^*$ into $w'(\vartheta)$ yields 
%
\begin{align*}
 w'(\vartheta) 
 &= -b \cos(\vartheta^*) + (a - pd)\sin(\vartheta^*) \\
 &= -b \frac{1}{\sqrt{\tan^2\vartheta^* + 1}} - (a - pd) \frac{\tan\vartheta^*}{\sqrt{\tan^2\vartheta^* + 1}} \\
 &= -b \frac{b}{\sqrt{(a-pd)^2 + b^2}} - (a - pd) \frac{a - pd}{\sqrt{(a-pd)^2 + b^2}} \\
 &= - \sqrt{(a-pd)^2 + b^2}.
\end{align*}
%
\NOTE{TODO: work out conditions for the integration domain to contain a zero of $w$}%
Hence, the $\vartheta$ integral reduces to
%
\begin{align*}
 \int_{-\beta_1\vartheta_0/2}^{\beta_1\vartheta_0/2} \Phi(\vartheta)\, \delta \big(w(\vartheta)\big) \, \D\vartheta = 
 \frac{\Phi(\vartheta^*)}{\sqrt{(a-pd)^2 + b^2}},
\end{align*}
%
and thus we acquire the backprojection
%
\begin{align}
 \label{eq:hconecurved:backproj}
 \DUALOPD g(x)
 &= \int_0^{2\pi} \frac{4}{\beta_1\beta_2\sqrt{r^2 - \sigma^2} \sqrt{(a-pd)^2 + b^2}} \cdot \phantom{x} \\
 &\hspace{35pt} g_0 \left( \phi - \arcsin(\sigma/r), 2\arcsin(\sigma/r)/\beta_1, 2\arctan\big((a-pd)/b\big)/\beta_2 \right)\, \D\phi. \notag
\end{align}
\vspace{5ex}%



\subsubsection{Detector curved only along $\phi$}
\label{sec:applications:cone_helical:curvedstack}

Straightforward application of the arguments from section \ref{sec:applications:cone_circular:curvedstack}. TODO
\vspace{5ex}%


\subsubsection{Flat detector}
\label{sec:applications:cone_helical:flat}

Straightforward application of the arguments from section \ref{sec:applications:cone_circular:flat}. TODO
\vspace{5ex}%


\subsection{PET and SPECT geometries -- big TODO}


\end{document}
